# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build-and-deploy:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v2
      - name: Setup .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 5.0.x

      # dotnet build and publish      
      - name: Build with dotnet
        run: dotnet build --configuration Release
      - name: dotnet publish 
        run: |
          dotnet publish -c Release -o myapp 
      # Log into Azure
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          environment: AzureChinaCloud         
    
      # deploy web app using Azure credentials
      - name: 'Azure webapp deploy'
        uses: azure/webapps-deploy@v1
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          package: './myapp' 


      - name: Azure WebApp      
        uses: Azure/webapps-deploy@v2
        with:
          # Name of the Azure Web App
          app-name: myblazor
          # Applies to Web Apps(Windows and Linux) and Web App Containers(linux). Multi container scenario not supported. Publish profile (*.publishsettings) file contents with Web Deploy secrets
          publish-profile: <publishData><publishProfile profileName="myblazor - Web Deploy" publishMethod="MSDeploy" publishUrl="myblazor.scm.chinacloudsites.cn:443" msdeploySite="myblazor" userName="$myblazor" userPWD="FEKBkKAuqEEJf62QjCBh90w7dyk4ivdeLZxLiBzRKkvbbShgvzuzueobqo4m" destinationAppUrl="http://myblazor.chinacloudsites.cn" SQLServerDBConnectionString="" mySQLDBConnectionString="" hostingProviderForumLink="" controlPanelLink="https://manage.windowsazure.cn" webSystem="WebSites"><databases /></publishProfile><publishProfile profileName="myblazor - FTP" publishMethod="FTP" publishUrl="ftp://cnws-prod-sha20-005.ftp.chinacloudsites.chinacloudapi.cn/site/wwwroot" ftpPassiveMode="True" userName="myblazor\$myblazor" userPWD="FEKBkKAuqEEJf62QjCBh90w7dyk4ivdeLZxLiBzRKkvbbShgvzuzueobqo4m" destinationAppUrl="http://myblazor.chinacloudsites.cn" SQLServerDBConnectionString="" mySQLDBConnectionString="" hostingProviderForumLink="" controlPanelLink="https://manage.windowsazure.cn" webSystem="WebSites"><databases /></publishProfile><publishProfile profileName="myblazor - Zip Deploy" publishMethod="ZipDeploy" publishUrl="myblazor.scm.chinacloudsites.cn:443" userName="$myblazor" userPWD="FEKBkKAuqEEJf62QjCBh90w7dyk4ivdeLZxLiBzRKkvbbShgvzuzueobqo4m" destinationAppUrl="http://myblazor.chinacloudsites.cn" SQLServerDBConnectionString="" mySQLDBConnectionString="" hostingProviderForumLink="" controlPanelLink="https://manage.windowsazure.cn" webSystem="WebSites"><databases /></publishProfile></publishData>         
          # Applies to Web App only: Path to package or folder. *.zip, *.war, *.jar or a folder to deploy
          package: './myapp' 
    
